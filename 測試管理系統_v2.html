<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦æ¡ˆä¾‹ç®¡ç†ç³»çµ± v2.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap');
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #475569;
            --accent: #06b6d4;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 20%, rgba(37, 99, 235, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }
        
        .toolbar {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .project-info {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .info-field {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .info-field label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .info-field input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .info-field input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .test-cases-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .test-cases-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans TC', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            font-size: 1.1rem;
            padding: 1rem 2rem;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-success:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .test-cases-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .test-case-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .test-case-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .test-case-id {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent);
        }
        
        .test-case-form {
            display: grid;
            gap: 1rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .upload-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .upload-area {
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }
        
        .upload-area input[type="file"] {
            display: none;
        }
        
        .upload-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .upload-text {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .file-list {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .file-item {
            background: var(--bg);
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .file-item-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .generate-section {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            margin-top: 2rem;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-item {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .notification.success {
            border-left: 4px solid var(--secondary);
        }
        
        .notification.error {
            border-left: 4px solid var(--danger);
        }
        
        .notification.warning {
            border-left: 4px solid var(--warning);
        }
        
        .required {
            color: var(--danger);
        }
        
        .info-banner {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: var(--text);
        }
        
        .info-banner strong {
            color: var(--primary);
        }
        
        /* æª”æ¡ˆä¸Šå‚³å€åŸŸæ”¹é€² */
        .upload-area.has-files {
            border-color: var(--secondary);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .upload-status {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--secondary);
            font-weight: 600;
        }
        
        /* åº•éƒ¨æ–°å¢æŒ‰éˆ•å€åŸŸ */
        .add-case-bottom {
            text-align: center;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .btn-large {
            font-size: 1.2rem;
            padding: 1rem 2.5rem;
        }
        
        /* åˆªé™¤æŒ‰éˆ•å€åŸŸ */
        .delete-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px dashed var(--border);
            text-align: center;
        }
        
        .btn-block {
            width: 100%;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹ç®¡ç†ç³»çµ± v2.0</h1>
            <p>è¼•é¬†ç®¡ç†æ¸¬è©¦æ¡ˆä¾‹ï¼Œä¸€éµç”Ÿæˆå°ˆæ¥­æ¸¬è©¦å ±å‘Š Excel</p>
            <div class="toolbar">
                <button class="btn btn-secondary" onclick="saveData()">ğŸ’¾ å„²å­˜è³‡æ–™</button>
                <button class="btn btn-secondary" onclick="loadData()">ğŸ“‚ è¼‰å…¥è³‡æ–™</button>
                <button class="btn btn-warning" onclick="exportJSON()">ğŸ“¤ åŒ¯å‡º JSON</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importJSON').click()">ğŸ“¥ åŒ¯å…¥ JSON</button>
                <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                <input type="file" id="importJSON" accept=".json" style="display:none" onchange="importJSON(event)">
            </div>
        </div>
        
        <div class="info-banner">
            <strong>ğŸ’¡ ä½¿ç”¨æç¤ºï¼š</strong><br>
            â€¢ æª”æ¡ˆä¸Šå‚³åŠŸèƒ½éœ€è¦å¾Œç«¯æœå‹™é‹è¡Œ (python backend_api.py)<br>
            â€¢ æ¸¬è©¦è³‡æ–™æœƒè‡ªå‹•å„²å­˜åˆ°ç€è¦½å™¨ï¼Œä¸‹æ¬¡é–‹å•Ÿæœƒè‡ªå‹•è¼‰å…¥<br>
            â€¢ å¯ä½¿ç”¨ã€ŒåŒ¯å‡º/åŒ¯å…¥ JSONã€åŠŸèƒ½å‚™ä»½æˆ–è½‰ç§»è³‡æ–™<br>
            â€¢ ç”Ÿæˆçš„ Excel æª”åæ ¼å¼ï¼šå°ˆæ¡ˆåç¨±_æ—¥æœŸæ™‚é–“.xlsx
        </div>
        
        <div class="project-info">
            <div class="info-field">
                <label>å°ˆæ¡ˆåç¨± <span class="required">*</span></label>
                <input type="text" id="projectName" value="ç³»çµ±åŠŸèƒ½æ¸¬è©¦" placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨±">
            </div>
            <div class="info-field">
                <label>æ¸¬è©¦è² è²¬äºº <span class="required">*</span></label>
                <input type="text" id="testLeader" value="å¼µä¸‰" placeholder="è¼¸å…¥è² è²¬äººå§“å">
            </div>
            <div class="info-field">
                <label>æ¸¬è©¦æ—¥æœŸ <span class="required">*</span></label>
                <input type="date" id="testDate">
            </div>
            <div class="info-field">
                <label>æ¸¬è©¦ç’°å¢ƒ <span class="required">*</span></label>
                <input type="text" id="testEnv" value="æ¸¬è©¦ç’°å¢ƒ v1.0" placeholder="è¼¸å…¥ç’°å¢ƒè³‡è¨Š">
            </div>
        </div>
        
        <div class="test-cases-header">
            <h2>æ¸¬è©¦æ¡ˆä¾‹æ¸…å–®</h2>
        </div>
        
        <div id="testCasesList" class="test-cases-list"></div>
        
        <div class="add-case-bottom">
            <button class="btn btn-primary btn-large" onclick="addTestCase()">
                â• æ–°å¢æ¸¬è©¦æ¡ˆä¾‹
            </button>
        </div>
        
        <div class="generate-section">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalCases">0</div>
                    <div class="stat-label">ç¸½æ¸¬è©¦æ¡ˆä¾‹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="passedCases">0</div>
                    <div class="stat-label">é€šéæ¡ˆä¾‹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="failedCases">0</div>
                    <div class="stat-label">å¤±æ•—æ¡ˆä¾‹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="passRate">0%</div>
                    <div class="stat-label">é€šéç‡</div>
                </div>
            </div>
            
            <button class="btn btn-success" id="generateBtn" onclick="generateReport()">
                ğŸ“Š ç”Ÿæˆæ¸¬è©¦å ±å‘Š Excel
            </button>
            
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨ç”Ÿæˆæ¸¬è©¦å ±å‘Š...</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        const STORAGE_KEY = 'testCases_data';
        
        let testCases = [];
        let caseCounter = 1;
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™
        window.addEventListener('load', function() {
            // è¨­å®šä»Šå¤©çš„æ—¥æœŸ
            document.getElementById('testDate').valueAsDate = new Date();
            
            // å˜—è©¦å¾ localStorage è¼‰å…¥è³‡æ–™
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    // è¼‰å…¥å°ˆæ¡ˆè³‡è¨Š
                    if (data.projectInfo) {
                        document.getElementById('projectName').value = data.projectInfo.projectName || '';
                        document.getElementById('testLeader').value = data.projectInfo.testLeader || '';
                        document.getElementById('testDate').value = data.projectInfo.testDate || '';
                        document.getElementById('testEnv').value = data.projectInfo.testEnv || '';
                    }
                    
                    // è¼‰å…¥æ¸¬è©¦æ¡ˆä¾‹
                    if (data.testCases && data.testCases.length > 0) {
                        testCases = data.testCases.map(tc => ({
                            ...tc,
                            expectedResult: tc.expectedResult || '',
                            screenshots: tc.screenshots || [],
                            dataFiles: tc.dataFiles || []
                        }));
                        console.log('è¼‰å…¥çš„æ¸¬è©¦æ¡ˆä¾‹:', testCases);
                        console.log('ç¬¬ä¸€å€‹æ¡ˆä¾‹çš„é æœŸçµæœ:', testCases[0].expectedResult);
                        caseCounter = Math.max(...testCases.map(tc => parseInt(tc.id.split('-')[1]))) + 1;
                        renderTestCases();
                        updateStats();
                        showNotification('å·²è‡ªå‹•è¼‰å…¥ä¸Šæ¬¡å„²å­˜çš„è³‡æ–™', 'success');
                    } else {
                        addTestCase(); // æ²’æœ‰è³‡æ–™æ™‚æ–°å¢ä¸€å€‹ç©ºç™½æ¡ˆä¾‹
                    }
                } catch (e) {
                    console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', e);
                    addTestCase();
                }
            } else {
                addTestCase(); // åˆæ¬¡ä½¿ç”¨,æ–°å¢ä¸€å€‹ç©ºç™½æ¡ˆä¾‹
            }
        });
        
        // è‡ªå‹•å„²å­˜åŠŸèƒ½ - ç•¶è³‡æ–™è®Šæ›´æ™‚è‡ªå‹•å„²å­˜
        function autoSave() {
            const data = {
                projectInfo: {
                    projectName: document.getElementById('projectName').value,
                    testLeader: document.getElementById('testLeader').value,
                    testDate: document.getElementById('testDate').value,
                    testEnv: document.getElementById('testEnv').value
                },
                testCases: testCases.map(tc => ({
                    id: tc.id,
                    requirement: tc.requirement,
                    case: tc.case,
                    precondition: tc.precondition,
                    steps: tc.steps,
                    testData: tc.testData,
                    expectedResult: tc.expectedResult,
                    priority: tc.priority,
                    result: tc.result,
                    tester: tc.tester
                    // æ³¨æ„ï¼šæª”æ¡ˆç‰©ä»¶ç„¡æ³•åºåˆ—åŒ–ï¼Œæ‰€ä»¥ä¸å„²å­˜
                }))
            };
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        
        function saveData() {
            autoSave();
            showNotification('è³‡æ–™å·²å„²å­˜åˆ°ç€è¦½å™¨ï¼', 'success');
        }
        
        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                location.reload(); // é‡æ–°è¼‰å…¥é é¢ä»¥è¼‰å…¥è³‡æ–™
            } else {
                showNotification('æ²’æœ‰æ‰¾åˆ°å„²å­˜çš„è³‡æ–™', 'warning');
            }
        }
        
        function clearAllData() {
            if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\n\né€™å°‡æœƒï¼š\nâ€¢ åˆªé™¤æ‰€æœ‰æ¸¬è©¦æ¡ˆä¾‹\nâ€¢ æ¸…é™¤ç€è¦½å™¨å„²å­˜çš„è³‡æ–™\nâ€¢ æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nå»ºè­°å…ˆåŒ¯å‡º JSON å‚™ä»½ã€‚')) {
                localStorage.removeItem(STORAGE_KEY);
                testCases = [];
                caseCounter = 1;
                renderTestCases();
                updateStats();
                showNotification('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼é é¢å°‡é‡æ–°è¼‰å…¥...', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        }
        
        function exportJSON() {
            const data = {
                projectInfo: {
                    projectName: document.getElementById('projectName').value,
                    testLeader: document.getElementById('testLeader').value,
                    testDate: document.getElementById('testDate').value,
                    testEnv: document.getElementById('testEnv').value
                },
                testCases: testCases.map(tc => ({
                    id: tc.id,
                    requirement: tc.requirement,
                    case: tc.case,
                    precondition: tc.precondition,
                    steps: tc.steps,
                    testData: tc.testData,
                    expectedResult: tc.expectedResult,
                    priority: tc.priority,
                    result: tc.result,
                    tester: tc.tester
                })),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ¸¬è©¦æ¡ˆä¾‹_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('JSON æª”æ¡ˆå·²åŒ¯å‡ºï¼', 'success');
        }
        
        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // è¼‰å…¥å°ˆæ¡ˆè³‡è¨Š
                    if (data.projectInfo) {
                        document.getElementById('projectName').value = data.projectInfo.projectName || '';
                        document.getElementById('testLeader').value = data.projectInfo.testLeader || '';
                        document.getElementById('testDate').value = data.projectInfo.testDate || '';
                        document.getElementById('testEnv').value = data.projectInfo.testEnv || '';
                    }
                    
                    // è¼‰å…¥æ¸¬è©¦æ¡ˆä¾‹
                    if (data.testCases) {
                        testCases = data.testCases.map(tc => ({
                            ...tc,
                            expectedResult: tc.expectedResult || '',
                            screenshots: [],
                            dataFiles: []
                        }));
                        caseCounter = Math.max(...testCases.map(tc => parseInt(tc.id.split('-')[1]))) + 1;
                        renderTestCases();
                        updateStats();
                        autoSave();
                        showNotification('JSON æª”æ¡ˆå·²æˆåŠŸåŒ¯å…¥ï¼', 'success');
                    }
                } catch (err) {
                    showNotification('åŒ¯å…¥å¤±æ•—ï¼šJSON æ ¼å¼éŒ¯èª¤', 'error');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            
            // æ¸…ç©º input ä»¥å…è¨±é‡è¤‡é¸æ“‡åŒä¸€å€‹æª”æ¡ˆ
            event.target.value = '';
        }
        
        function addTestCase() {
            const id = `TC-${String(caseCounter).padStart(3, '0')}`;
            const testCase = {
                id: id,
                requirement: '',
                case: '',
                precondition: '',
                steps: '',
                testData: '',
                expectedResult: '',
                priority: 'ä¸­',
                result: 'å¾…æ¸¬è©¦',
                tester: '',
                screenshots: [],
                dataFiles: []
            };
            
            testCases.push(testCase);
            caseCounter++;
            renderTestCases();
            updateStats();
            autoSave();
        }
        
        function removeTestCase(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¸¬è©¦æ¡ˆä¾‹å—?')) {
                testCases = testCases.filter(tc => tc.id !== id);
                renderTestCases();
                updateStats();
                autoSave();
                showNotification('æ¸¬è©¦æ¡ˆä¾‹å·²åˆªé™¤', 'success');
            }
        }
        
        function renderTestCases() {
            const container = document.getElementById('testCasesList');
            
            if (testCases.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <h3>å°šæœªæ–°å¢æ¸¬è©¦æ¡ˆä¾‹</h3>
                        <p>é»æ“Šä¸Šæ–¹ã€Œæ–°å¢æ¸¬è©¦æ¡ˆä¾‹ã€æŒ‰éˆ•é–‹å§‹</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = testCases.map(tc => `
                <div class="test-case-card">
                    <div class="test-case-header">
                        <span class="test-case-id">${tc.id}</span>
                    </div>
                    
                    <div class="test-case-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ¸¬è©¦éœ€æ±‚ <span class="required">*</span></label>
                                <input type="text" value="${tc.requirement}" 
                                    onchange="updateTestCase('${tc.id}', 'requirement', this.value)"
                                    placeholder="ä¾‹: ä½¿ç”¨è€…ç™»å…¥åŠŸèƒ½">
                            </div>
                            <div class="form-group">
                                <label>æ¸¬è©¦äººå“¡ <span class="required">*</span></label>
                                <input type="text" value="${tc.tester}" 
                                    onchange="updateTestCase('${tc.id}', 'tester', this.value)"
                                    placeholder="ä¾‹: å¼µä¸‰">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>æ¸¬è©¦å€‹æ¡ˆ <span class="required">*</span></label>
                            <input type="text" value="${tc.case}" 
                                onchange="updateTestCase('${tc.id}', 'case', this.value)"
                                placeholder="ä¾‹: é©—è­‰æ­£ç¢ºçš„å¸³è™Ÿå¯†ç¢¼å¯ä»¥æˆåŠŸç™»å…¥ç³»çµ±">
                        </div>
                        
                        <div class="form-group">
                            <label>å‰ç½®æ¢ä»¶</label>
                            <textarea onchange="updateTestCase('${tc.id}', 'precondition', this.value)"
                                placeholder="ä¾‹: 1. ç³»çµ±å·²å•Ÿå‹•&#10;2. æ¸¬è©¦å¸³è™Ÿå·²å»ºç«‹&#10;3. è³‡æ–™åº«é€£ç·šæ­£å¸¸">${tc.precondition}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>æ¸¬è©¦æ­¥é©Ÿ <span class="required">*</span></label>
                            <textarea onchange="updateTestCase('${tc.id}', 'steps', this.value)"
                                placeholder="ä¾‹: 1. é–‹å•Ÿç™»å…¥é é¢&#10;2. è¼¸å…¥æ­£ç¢ºå¸³è™Ÿ&#10;3. è¼¸å…¥æ­£ç¢ºå¯†ç¢¼&#10;4. é»æ“Šç™»å…¥æŒ‰éˆ•">${tc.steps}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>æ¸¬è©¦è³‡æ–™ (æ–‡å­—)</label>
                            <textarea onchange="updateTestCase('${tc.id}', 'testData', this.value)"
                                placeholder="ä¾‹: å¸³è™Ÿ: testuser01&#10;å¯†ç¢¼: Test@1234">${tc.testData}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>æ¸¬è©¦è³‡æ–™ (æª”æ¡ˆä¸Šå‚³)</label>
                            <div class="upload-area ${(tc.dataFiles && tc.dataFiles.length > 0) ? 'has-files' : ''}" onclick="document.getElementById('datafiles-${tc.id}').click()">
                                <input type="file" id="datafiles-${tc.id}" multiple 
                                    onchange="handleFileUpload('${tc.id}', 'dataFiles', this.files)">
                                <div class="upload-icon">ğŸ“</div>
                                <div class="upload-text">é»æ“Šä¸Šå‚³æ¸¬è©¦è³‡æ–™æª”æ¡ˆåˆ°ä¼ºæœå™¨</div>
                                ${(tc.dataFiles && tc.dataFiles.length > 0) ? `<div class="upload-status">âœ“ å·²ä¸Šå‚³ ${tc.dataFiles.filter(f => f.uploaded !== false).length} å€‹æª”æ¡ˆ</div>` : ''}
                                <div class="file-list" id="datafiles-list-${tc.id}">
                                    ${(tc.dataFiles || []).map((file, idx) => `
                                        <div class="file-item">
                                            <span>${file.uploaded === false ? 'âŒ' : 'âœ…'} ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                                            <button class="file-item-remove" onclick="removeFile(event, '${tc.id}', 'dataFiles', ${idx})">âœ•</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>é æœŸçµæœ <span class="required">*</span></label>
                            <textarea onchange="updateTestCase('${tc.id}', 'expectedResult', this.value)"
                                placeholder="ä¾‹: ç³»çµ±é¡¯ç¤ºã€Œç™»å…¥æˆåŠŸã€è¨Šæ¯&#10;ä½¿ç”¨è€…å°å‘ä¸»é é¢&#10;ä¸»é é¢é¡¯ç¤ºä½¿ç”¨è€…åç¨±">${tc.expectedResult !== undefined && tc.expectedResult !== null ? tc.expectedResult : ''}</textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>å„ªå…ˆç´š <span class="required">*</span></label>
                                <select onchange="updateTestCase('${tc.id}', 'priority', this.value)">
                                    <option value="é«˜" ${tc.priority === 'é«˜' ? 'selected' : ''}>é«˜</option>
                                    <option value="ä¸­" ${tc.priority === 'ä¸­' ? 'selected' : ''}>ä¸­</option>
                                    <option value="ä½" ${tc.priority === 'ä½' ? 'selected' : ''}>ä½</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>åŸ·è¡Œçµæœ <span class="required">*</span></label>
                                <select onchange="updateTestCase('${tc.id}', 'result', this.value); updateStats()">
                                    <option value="é€šé" ${tc.result === 'é€šé' ? 'selected' : ''}>âœ… é€šé</option>
                                    <option value="å¤±æ•—" ${tc.result === 'å¤±æ•—' ? 'selected' : ''}>âŒ å¤±æ•—</option>
                                    <option value="å¾…æ¸¬è©¦" ${tc.result === 'å¾…æ¸¬è©¦' ? 'selected' : ''}>â³ å¾…æ¸¬è©¦</option>
                                    <option value="è·³é" ${tc.result === 'è·³é' ? 'selected' : ''}>â­ è·³é</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="upload-section">
                            <div class="upload-area ${(tc.screenshots && tc.screenshots.length > 0) ? 'has-files' : ''}" onclick="document.getElementById('screenshots-${tc.id}').click()">
                                <input type="file" id="screenshots-${tc.id}" multiple accept="image/*" 
                                    onchange="handleFileUpload('${tc.id}', 'screenshots', this.files)">
                                <div class="upload-icon">ğŸ“¸</div>
                                <div class="upload-text">é»æ“Šä¸Šå‚³åŸ·è¡Œæˆªåœ–åˆ°ä¼ºæœå™¨</div>
                                ${(tc.screenshots && tc.screenshots.length > 0) ? `<div class="upload-status">âœ“ å·²ä¸Šå‚³ ${tc.screenshots.filter(f => f.uploaded !== false).length} å€‹æª”æ¡ˆ</div>` : ''}
                                <div class="file-list" id="screenshots-list-${tc.id}">
                                    ${(tc.screenshots || []).map((file, idx) => `
                                        <div class="file-item">
                                            <span>${file.uploaded === false ? 'âŒ' : 'âœ…'} ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                                            <button class="file-item-remove" onclick="removeFile(event, '${tc.id}', 'screenshots', ${idx})">âœ•</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="delete-section">
                            <button class="btn btn-danger btn-block" onclick="removeTestCase('${tc.id}')">
                                ğŸ—‘ åˆªé™¤æ­¤æ¸¬è©¦æ¡ˆä¾‹
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateTestCase(id, field, value) {
            const testCase = testCases.find(tc => tc.id === id);
            if (testCase) {
                testCase[field] = value;
                autoSave();
            }
        }
        
        function handleFileUpload(id, type, files) {
            const testCase = testCases.find(tc => tc.id === id);
            if (!testCase || files.length === 0) return;
            
            const fileType = type === 'screenshots' ? 'åŸ·è¡Œæˆªåœ–' : 'æ¸¬è©¦è³‡æ–™æª”æ¡ˆ';
            showNotification(`æ­£åœ¨ä¸Šå‚³ ${files.length} å€‹${fileType}...`, 'warning');
            
            // ä¸Šå‚³æ¯å€‹æª”æ¡ˆ
            let uploadedCount = 0;
            let failedCount = 0;
            const uploadedFiles = [];
            
            Array.from(files).forEach(async (file, index) => {
                try {
                    // å‰µå»º FormData
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('testCaseId', id);
                    formData.append('fileType', type);
                    
                    // ä¸Šå‚³åˆ°å¾Œç«¯
                    const response = await fetch(`${API_URL}/api/upload-file`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        uploadedFiles.push({
                            name: file.name,
                            size: file.size,
                            path: result.path,
                            uploaded: true
                        });
                        uploadedCount++;
                    } else {
                        failedCount++;
                        uploadedFiles.push({
                            name: file.name,
                            size: file.size,
                            uploaded: false
                        });
                    }
                } catch (error) {
                    console.error('ä¸Šå‚³å¤±æ•—:', error);
                    failedCount++;
                    uploadedFiles.push({
                        name: file.name,
                        size: file.size,
                        uploaded: false
                    });
                }
                
                // æ‰€æœ‰æª”æ¡ˆä¸Šå‚³å®Œæˆ
                if (uploadedCount + failedCount === files.length) {
                    testCase[type] = [...testCase[type], ...uploadedFiles];
                    renderTestCases();
                    autoSave();
                    
                    if (failedCount === 0) {
                        const fileNames = uploadedFiles.map(f => f.name).join('ã€');
                        showNotification(
                            `âœ… æˆåŠŸä¸Šå‚³ ${uploadedCount} å€‹${fileType}\n\næª”æ¡ˆåç¨±ï¼š\n${fileNames}\n\nâ€» æª”æ¡ˆå·²å„²å­˜åˆ°ä¼ºæœå™¨`,
                            'success'
                        );
                    } else {
                        showNotification(
                            `âš ï¸ ä¸Šå‚³å®Œæˆ\næˆåŠŸ: ${uploadedCount} å€‹\nå¤±æ•—: ${failedCount} å€‹\n\nè«‹æª¢æŸ¥å¾Œç«¯æœå‹™æ˜¯å¦é‹è¡Œ`,
                            'warning'
                        );
                    }
                }
            });
        }
        
        function removeFile(event, id, type, index) {
            event.stopPropagation();
            const testCase = testCases.find(tc => tc.id === id);
            if (testCase) {
                testCase[type].splice(index, 1);
                renderTestCases();
            }
        }
        
        function updateStats() {
            const total = testCases.length;
            const passed = testCases.filter(tc => tc.result === 'é€šé').length;
            const failed = testCases.filter(tc => tc.result === 'å¤±æ•—').length;
            const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;
            
            document.getElementById('totalCases').textContent = total;
            document.getElementById('passedCases').textContent = passed;
            document.getElementById('failedCases').textContent = failed;
            document.getElementById('passRate').textContent = passRate + '%';
            
            autoSave();
        }
        
        async function generateReport() {
            // é©—è­‰å¿…å¡«æ¬„ä½
            const projectName = document.getElementById('projectName').value;
            const testLeader = document.getElementById('testLeader').value;
            const testDate = document.getElementById('testDate').value;
            const testEnv = document.getElementById('testEnv').value;
            
            if (!projectName || !testLeader || !testDate || !testEnv) {
                showNotification('è«‹å¡«å¯«å®Œæ•´çš„å°ˆæ¡ˆè³‡è¨Šï¼', 'error');
                return;
            }
            
            const emptyFields = testCases.filter(tc => 
                !tc.requirement || !tc.case || !tc.steps || !tc.expectedResult || !tc.tester
            );
            
            if (emptyFields.length > 0) {
                showNotification(
                    `è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼ä»¥ä¸‹æ¸¬è©¦æ¡ˆä¾‹æœ‰å¿…å¡«æ¬„ä½æœªå¡«å¯«:\n${emptyFields.map(tc => tc.id).join(', ')}`,
                    'error'
                );
                return;
            }
            
            // æº–å‚™è³‡æ–™
            const data = {
                projectInfo: {
                    projectName: projectName,
                    testLeader: testLeader,
                    testDate: testDate,
                    testEnv: testEnv
                },
                testCases: testCases.map(tc => ({
                    id: tc.id,
                    requirement: tc.requirement,
                    case: tc.case,
                    precondition: tc.precondition,
                    steps: tc.steps,
                    testData: tc.testData,
                    expectedResult: tc.expectedResult,
                    priority: tc.priority,
                    result: tc.result,
                    tester: tc.tester,
                    screenshots: tc.screenshots.filter(f => f.uploaded !== false).map(f => ({
                        name: f.name,
                        path: f.path
                    })),
                    dataFiles: tc.dataFiles.filter(f => f.uploaded !== false).map(f => ({
                        name: f.name,
                        path: f.path
                    }))
                }))
            };
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            document.getElementById('loading').classList.add('active');
            document.getElementById('generateBtn').disabled = true;
            
            try {
                // å‘¼å«å¾Œç«¯API
                const response = await fetch(`${API_URL}/api/generate-report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error('ç”Ÿæˆå ±å‘Šå¤±æ•—');
                }
                
                // ä¸‹è¼‰Excelæª”æ¡ˆ
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // ä½¿ç”¨å°ˆæ¡ˆåç¨±å’Œæ—¥æœŸæ™‚é–“ä½œç‚ºæª”å
                const now = new Date();
                const dateStr = now.toISOString().slice(0,10).replace(/-/g, '');
                const timeStr = now.toTimeString().slice(0,8).replace(/:/g, '');
                a.download = `${projectName}_${dateStr}_${timeStr}.xlsx`;
                
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification('æ¸¬è©¦å ±å‘Šå·²æˆåŠŸç”Ÿæˆä¸¦ä¸‹è¼‰ï¼\næª”å: ' + a.download, 'success');
                
            } catch (error) {
                console.error('ç”Ÿæˆå ±å‘ŠéŒ¯èª¤:', error);
                showNotification(
                    'âŒ ç”Ÿæˆå ±å‘Šå¤±æ•—ï¼\n\nå¯èƒ½åŸå› ï¼š\n1. å¾Œç«¯æœå‹™æœªé‹è¡Œ\n   â†’ è«‹åŸ·è¡Œ: python backend_api.py\n2. API åœ°å€éŒ¯èª¤\n3. ç¶²è·¯é€£ç·šå•é¡Œ\n\nè«‹æª¢æŸ¥ç€è¦½å™¨ Console æŸ¥çœ‹è©³ç´°éŒ¯èª¤',
                    'error'
                );
            } finally {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('generateBtn').disabled = false;
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.whiteSpace = 'pre-line'; // æ”¯æ´æ›è¡Œ
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
    </script>
</body>
</html>
